<!DOCTYPE html>
<html>
  <head>
    <title>Account Handler</title>
    <link rel="stylesheet" href="https://unpkg.com/@shoelace-style/shoelace@^2/cdn/themes/light.css" />
    <script type="module" src="https://unpkg.com/@shoelace-style/shoelace@^2/cdn/shoelace.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        background-color: #f8f9fa;
        display: flex;
        justify-content: center;
      }
      .container {
        width: 100%;
        max-width: 80ch;
        padding: 2rem 1rem;
        box-sizing: border-box;
      }
      main {
        margin-top: 2rem;
      }
      form {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
      }
      form sl-input {
        flex: 1 1 200px;
        min-width: 0;
      }
      .nav-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
      }
      .title {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <sl-card class="nav-card" style="padding: 1rem;">
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="title">Account Handler</div>
            <form action="." method="get">
              <sl-input type="search" id="actor-search" name="q" placeholder="Search actorâ€¦" clearable></sl-input>
              <sl-button type="submit" variant="primary">Show</sl-button>
            </form>
            <div class="nav-buttons">
              <sl-button variant="default" onclick="registerAcctHandler()">Register Handler</sl-button>
              <sl-button variant="default" onclick="unregisterAcctHandler()">Unregister</sl-button>
              <sl-button href="https://socialwebfoundation.org/" target="_blank" variant="text">Social Web Foundation</sl-button>
              <sl-button href="https://github.com/social-web-foundation/acct-handler" target="_blank" variant="text">GitHub</sl-button>
            </div>
          </div>
        </sl-card>
      </header>

      <main>
        <section id="account"></section>
      </main>
    </div>

    <script type="module">
      import { ActivityPubElement } from "https://unpkg.com/@socialwebfoundation/ap-components";

      function registerAcctHandler() {
        const loc = document.location.origin + document.location.pathname;
        console.log("Registering protocol handler");
        const handler = `${loc}?q=%s`;
        navigator.registerProtocolHandler("web+acct", handler);
      }

      function unregisterAcctHandler() {
        const loc = document.location.origin + document.location.pathname;
        console.log("Unregistering protocol handler");
        const handler = `${loc}?q=%s`;
        navigator.unregisterProtocolHandler("web+acct", handler);
      }

      window.registerAcctHandler = registerAcctHandler;
      window.unregisterAcctHandler = unregisterAcctHandler;

      window.onload = () => {
        ActivityPubElement.fetchFunction = async (url, options) =>
          fetch('/api/proxy', {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({ id: url }),
          });

        const address = new URLSearchParams(document.location.search).get("q");

        if (address) {
          const search = document.getElementById("actor-search");
          customElements.whenDefined('sl-input').then(() => {
            search.value = address;
          });
          let protocol, webfinger;
          if (address.match(/(\w+):(\w+)@([\w\.]+)/)) {
            [protocol, webfinger] = address.split(':', 1);
          } else if (address.match(/(\w+)@([\w\.]+)/)) {
            protocol = 'acct:';
            webfinger = address;
          }
          if (['acct:', 'web+acct:'].includes(protocol) && webfinger) {
            const account = document.getElementById("account");
            customElements.whenDefined('ap-actor-page').then(() => {
              account.innerHTML = `<ap-actor-page webfinger="acct:${webfinger}"></ap-actor-page>`;
            });
          }
        }
      };
    </script>
  </body>
</html>
